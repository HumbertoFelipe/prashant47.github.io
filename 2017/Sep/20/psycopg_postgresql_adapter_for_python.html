<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width">
  <title>Psycopg: PostgreSQL adapter for Python</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.1/css/bulma.min.css">
    <link rel="stylesheet" href="/theme/css/main.365169ea.css">
    <link rel="stylesheet" href="/theme/webassets-external/5f88595a9ad2c678b16c0d171e6e0a71_print.css" media="print">
<meta property="og:title" content="Heuristic Intelligence - Psycopg: PostgreSQL adapter for Python">
  <meta property="og:description" content="Getting started with PostgreSQL in python using psycopg">
<meta property="og:url" content="/2017/Sep/20/psycopg_postgresql_adapter_for_python.html">
<meta name="twitter:card" content="summary">
<meta property="og:site_name" content="Heuristic Intelligence">
<meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-09-20T00:08:00+05:30">
    <meta property="article:tag" content="python">
    <meta property="article:tag" content="postgres">
  <meta property="article:section" content="Python">
</head>

<body id="index" class="home">
<header class="hero is-primary">
  <div class="hero-head">
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <a class="nav-item is-brand title is-3"
             href="/">Heuristic Intelligence</a>
        </div>
      </nav>
    </div>
  </div>
</header>

<nav class="nav has-shadow is-hidden-print">
  <div class="container">
    <div class="nav-center"></div>
    <span id="navToggle" class="nav-toggle">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="navMenu" class="nav-right nav-menu">
          <a class="nav-item is-tab "
             href="/category/graphlab.html">GraphLab</a>
          <a class="nav-item is-tab "
             href="/category/machine-learning.html">Machine Learning</a>
          <a class="nav-item is-tab "
             href="/category/misc.html">Misc</a>
          <a class="nav-item is-tab is-active"
             href="/category/python.html">Python</a>
          <a class="nav-item is-tab "
             href="/category/statistics.html">Statistics</a>
    </div>
  </div>
</nav>

<div class="container">
  <div class="section columns">
    <div class="column is-three-quarters-desktop is-two-thirds-tablet">
<section id="content" class="body">
  <article>
    <h1 class="title">
      <a href="/2017/Sep/20/psycopg_postgresql_adapter_for_python.html" rel="bookmark"
         title="Permalink to Psycopg: PostgreSQL adapter for Python">Psycopg: PostgreSQL adapter for Python</a></h1>
<footer class="post-info">
  <abbr class="published" title="2017-09-20T00:08:00+05:30">
    Published <span class="is-info">Wed 20 September 2017</span>
    in <a href="/category/python.html">Python</a>
  </abbr>

    <p class="author">
      <em>by           Prashant Gonarkar
</em>
      <span class="tag is-small"><a href="/tag/python.html">python</a></span>
      <span class="tag is-small"><a href="/tag/postgres.html">postgres</a></span>
    </p>
  
</footer>    <div class="section"><p><a href="https://www.postgresql.org/">PostgreSQL</a> is one the most popular open source object-relational database system &amp; heavily being used in industry. On the other hand python is widely used multiple programming paradigm language. If you want to work in PostgreSQL using python, the best choice would be Psycopg. <a href="http://initd.org/psycopg/">Psycopg</a> is the most popular PostgreSQL adapter for python. It fully implements <a href="www.python.org/dev/peps/pep-0249/">Python DB API 2.0</a>. Psycopg2 is designed for multi-threaded applications and maintaines its own connection pool. <br/> One of nice feature that psycopg2 driver supports, it matches Python objects to the PostgreSQL data types e.g list to the array, tuples to records, and dictionary to hstore.
The following tutorials will demonstrate basic usage of psycopg.</p>
<div class="highlight"><pre><span></span><span class="c1"># Python 3.5</span>
<span class="c1"># Connecting to PostgreSQL database from python </span>

<span class="c1"># importing psycopg2 module</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;dbname=&#39;tempdb&#39; user=&#39;postgres&#39; host=&#39;localhost&#39; password=&#39;postgres&#39;&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Error: unable to connect to the database&quot;</span><span class="p">,</span><span class="n">ex</span> <span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># we got connection </span>
<span class="n">conn</span>
</pre></div>


<div class="highlight"><pre><span></span>&lt;connection object at 0x7f93202a5e88; dsn: &#39;user=postgres host=localhost dbname=tempdb password=xxx&#39;, closed: 0&gt;
</pre></div>


<p>After connecting to database, we need to create cursor by the connection.cursor() method. And they are bound to the connection for the entire lifetime.</p>
<div class="highlight"><pre><span></span><span class="c1"># Creating cursor</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>


<p>Now after having the cursor defined we can execute a query by cursor.execute() function. </p>
<div class="highlight"><pre><span></span><span class="c1"># Let&#39;s fetch 5 rows from test table</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM test LIMIT 5;&quot;</span><span class="p">)</span>
</pre></div>


<p>To get the results returned by query there are multiple functions available in psycopg2 based on return values e.g fetchall()(), fetchone() &amp; fetchmany() </p>
<div class="highlight"><pre><span></span><span class="c1"># Let&#39;s get all the data retrieved by query</span>
<span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>[(1, 122, 5.0), (1, 185, 5.0), (1, 231, 5.0), (1, 292, 5.0), (1, 316, 5.0)]
</pre></div>


<p>As you can see above psycopg2 automatically converts data into python built-in list.</p>
<p>Now Let's create a new table in given database.</p>
<div class="highlight"><pre><span></span><span class="c1"># Creating new table using SQL query</span>

<span class="n">tablename</span> <span class="o">=</span> <span class="s2">&quot;ratings&quot;</span>
<span class="n">USER_ID_COLNAME</span> <span class="o">=</span> <span class="s1">&#39;userId&#39;</span>
<span class="n">MOVIE_ID_COLNAME</span> <span class="o">=</span> <span class="s1">&#39;movieId&#39;</span>
<span class="n">RATING_COLNAME</span> <span class="o">=</span> <span class="s1">&#39;rating&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE {0} ( {1} integer, {2} integer,{3} real);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span>
                                                        <span class="n">USER_ID_COLNAME</span><span class="p">,</span>
                                                        <span class="n">MOVIE_ID_COLNAME</span><span class="p">,</span>
                                                        <span class="n">RATING_COLNAME</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Failed to create table: &quot;</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Created table:  &quot;</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>Created table:   ratings
</pre></div>


<p>Table created sucessfully .! Now let's add some data. psycopg2 supports PostgreSQL's COPY command.</p>
<div class="highlight"><pre><span></span><span class="c1"># Adding data from csv file using COPY method of PostgreSQL</span>
<span class="c1"># datafile is sample.csv</span>

<span class="n">tablename</span> <span class="o">=</span> <span class="s2">&quot;ratings&quot;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sample.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span><span class="n">tablename</span> <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Failed to copy file in database: &quot;</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
</pre></div>


<p>Now let's fetch added data</p>
<div class="highlight"><pre><span></span><span class="c1"># Running select query and feching data </span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ratings LIMIT 5;&quot;</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">rows</span>
</pre></div>


<div class="highlight"><pre><span></span>[(1, 122, 5.0), (1, 185, 5.0), (1, 231, 5.0), (1, 292, 5.0), (1, 316, 5.0)]
</pre></div>


<p>Let's count the the number of rows in table. Here we will use fetchone()</p>
<div class="highlight"><pre><span></span><span class="c1"># count the number of rows</span>

<span class="n">tablename</span> <span class="o">=</span> <span class="s2">&quot;ratings&quot;</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT count(*) FROM {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">count</span>
</pre></div>


<div class="highlight"><pre><span></span>400
</pre></div>


<p>Similarly let's count number of tables</p>
<div class="highlight"><pre><span></span><span class="c1"># counting no of tables in schema</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot; SELECT COUNT(table_name) FROM information_schema.tables WHERE table_schema = &#39;public&#39; &quot;</span>                                                                         
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">count</span>
</pre></div>


<div class="highlight"><pre><span></span>4
</pre></div>


<p>Let's delete perticular table.</p>
<div class="highlight"><pre><span></span><span class="c1"># deleting ratings table </span>
<span class="n">RATINGS_TABLE</span> <span class="o">=</span> <span class="s1">&#39;ratings&#39;</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE IF EXISTS {0} CASCADE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">RATINGS_TABLE</span><span class="p">))</span>
<span class="n">cur</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<p>PostgreSQL does not have an autocommit option which means all the queries will have to be executed within a transaction. This functionality ensures data integrity and allows for appropriate error handling but there are queries that can not be run from within a transaction. Let's see example.</p>
<div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP DATABASE tempd&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Failed to drop our test database!&quot;</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>Failed to drop our test database! DROP DATABASE cannot run inside a transaction block
</pre></div>


<p>PostgreSQL can not drop databases within a transaction, if you want to drop database within a transaction then you need to change the isolation level of the database as follows.</p>
<div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>


<p>This was short introduction to psycopg, I hope you have enjoyed. See you next time.</p>
<h2>References</h2>
<ol>
<li><a href="http://initd.org/psycopg/">Psycopg official website</a></li>
<li><a href="https://wiki.postgresql.org/wiki/Psycopg2_Tutorial">PostgreSQL psycopg2 tutorial</a></li>
</ol></div>

  </article>
</section>

<script type="application/ld+json">
  {"articleSection": "Python", "mainEntityOfPage": {"@type": "WebPage", "@id": "/2017/Sep/20/psycopg_postgresql_adapter_for_python.html"}, "headline": "Psycopg: PostgreSQL adapter for Python", "datePublished": "2017-09-20T00:08:00+05:30", "@context": "http://schema.org", "author": {"name": "Prashant Gonarkar", "@type": "Person"}, "@type": "BlogPosting", "description": "Getting started with PostgreSQL in python using psycopg"}
</script>
    </div>

    <div class="column is-one-quarter-desktop is-one-third-tablet is-hidden-print">
      <aside class="menu">
          <p class="menu-label">Links</p>
          <ul class="menu-list">
                <li><a                        href="/pages/about.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">About</span>
                </a></li>
                <li><a                        href="/pages/projects.html">
                  <span class="icon is-small"><i class="fa fa-book"></i></span>
                  <span class="link-text">Projects</span>
                </a></li>
          </ul>
<p class="menu-label">Social</p>
<ul class="menu-list">
    <li><a href="https://github.com/prashant47">
      <span class="icon is-small">
          <i class="fa fa-github fa-fw"></i>
      </span>
      <span class="link-text">GitHub</span>
    </a></li>
    <li><a href="http://facebook.com/prashantgonarkar">
      <span class="icon is-small">
          <i class="fa fa-facebook-official fa-fw"></i>
      </span>
      <span class="link-text">Facebook</span>
    </a></li>
    <li><a href="https://twitter.com/pgonarkar">
      <span class="icon is-small">
          <i class="fa fa-twitter fa-fw"></i>
      </span>
      <span class="link-text">Twitter</span>
    </a></li>
    <li><a href="https://linkedin.com/in/pgonarkar">
      <span class="icon is-small">
          <i class="fa fa-linkedin fa-fw"></i>
      </span>
      <span class="link-text">Linkedin</span>
    </a></li>
</ul>          <p class="menu-label">License</p>
          
<ul class="menu-list">
  <li>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <span class="icon is-small">
        <i class="fa fa-creative-commons fa-fw"></i>
      </span>
      <span>CC BY-SA 4.0</span>
    </a>
  </li>
</ul>

      </aside>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container has-text-centered">
 <p class="subtitle">The question of whether a computer can think is no more interesting than the question of whether a submarine can swim.― Edsger W. Dijkstra</p>    <p><a href="https://github.com/textbook/bulrush">Bulrush</a> theme for
        <a href="https://blog.getpelican.com/">Pelican</a>
      | <span class="icon is-small"><i class="fa fa-html5"></i></span> HTML 5
      | <span class="icon is-small"><i class="fa fa-css3"></i></span> CSS 3
    </p>
  </div>
</footer>

<script type="text/javascript">
  document.getElementById('navToggle').addEventListener('click', function () {
    var nav = document.getElementById('navMenu');
    var className = nav.getAttribute('class');
    if (className == 'nav-right nav-menu') {
      nav.className = 'nav-right nav-menu is-active';
    } else {
      nav.className = 'nav-right nav-menu';
    }
  });
</script>
</body>
</html>